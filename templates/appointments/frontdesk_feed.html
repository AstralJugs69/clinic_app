{% extends "base.html" %}
{% block content %}

<div class="max-w-6xl mx-auto px-4 py-6 space-y-5">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">Front Desk Live Board</h1>
      <p class="text-sm text-gray-500">Real-time check-in and queue handoff.</p>
      {% if doctor_busy %}
      <p class="text-xs text-amber-700 mt-1">Doctor is in session. New check-ins are paused until current treatment is finished.</p>
      {% endif %}
    </div>
    <div class="flex gap-2 flex-wrap">
      <a href="{% url 'appointments:today' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Schedule</a>
      <a href="{% url 'appointments:doctor_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Doctor Feed</a>
      {% for room_item in rooms %}
      <a href="{% url 'appointments:room_feed' room_item.code %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">{{ room_item.name }}</a>
      {% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="bg-white shadow rounded p-3">
      <p class="text-xs text-gray-500">Queued (Planned)</p>
      <p class="text-xl font-semibold text-gray-800">{{ queue_counts.planned }}</p>
    </div>
    <div class="bg-white shadow rounded p-3">
      <p class="text-xs text-gray-500">Checked In Waiting Doctor</p>
      <p class="text-xl font-semibold text-blue-700">{{ queue_counts.waiting_doctor }}</p>
    </div>
    <div class="bg-white shadow rounded p-3">
      <p class="text-xs text-gray-500">Emergency in Queue</p>
      <p class="text-xl font-semibold text-red-700">{{ queue_counts.emergency }}</p>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2 bg-white shadow rounded p-4">
      <h2 class="text-lg font-semibold">Register Walk-In Check-In</h2>
      <p class="text-sm text-gray-500 mb-3">Use this for unscheduled arrivals and emergencies.</p>

      <form method="post" action="{% url 'appointments:frontdesk_intake' %}" class="grid md:grid-cols-12 gap-3">
        {% csrf_token %}

        <div class="md:col-span-4">
          <label class="text-xs font-medium text-gray-600 mb-1 block">Patient</label>
          {{ intake_form.patient }}
        </div>

        <div class="md:col-span-4">
          <label class="text-xs font-medium text-gray-600 mb-1 block">Reason</label>
          {{ intake_form.reason }}
        </div>

        <div class="md:col-span-2">
          <label class="text-xs font-medium text-gray-600 mb-1 block">Duration (min)</label>
          {{ intake_form.duration_minutes }}
        </div>

        <div class="md:col-span-2 flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-red-700 font-medium">
            {{ intake_form.emergency }}
            Emergency
          </label>
        </div>

        <div class="md:col-span-12">
          <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">
            Register Check-In
          </button>
        </div>
      </form>

      {% if intake_form.errors %}
      <div class="mt-3 p-3 bg-red-50 border border-red-100 rounded text-sm text-red-700">
        {% for field in intake_form %}
          {% for error in field.errors %}
            <p>{{ field.label }}: {{ error }}</p>
          {% endfor %}
        {% endfor %}
        {% for error in intake_form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <div class="bg-white shadow rounded p-4 space-y-3">
      <h2 class="text-lg font-semibold">Quick Actions</h2>
      <a href="{% url 'patients:new' %}" class="block w-full text-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        + New Patient
      </a>
      <a href="{% url 'appointments:new' %}" class="block w-full text-center border px-4 py-2 rounded hover:bg-gray-50">
        + New Scheduled Appointment
      </a>
      <p class="text-xs text-gray-500">Emergency check-ins are flagged and move to doctor queue instantly.</p>
    </div>
  </div>

  <div class="overflow-x-auto bg-white shadow rounded">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Time</th>
          <th class="px-4 py-2 text-left">Patient</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-left">Room</th>
          <th class="px-4 py-2 text-right">Action</th>
        </tr>
      </thead>
      <tbody id="frontdesk-body">
        {% for item in appointments %}
        <tr class="border-t hover:bg-gray-50 {% if item.reason and '[EMERGENCY]' in item.reason %}bg-red-50{% endif %}" data-appointment-id="{{ item.id }}" data-status-code="{{ item.status }}">
          <td class="px-4 py-2" data-field="time">{{ item.scheduled_at|date:"H:i" }}</td>
          <td class="px-4 py-2 font-medium" data-field="patient">
            {{ item.patient.full_name }}
            {% if item.reason and '[EMERGENCY]' in item.reason %}
            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-xs font-semibold">Emergency</span>
            {% endif %}
          </td>
          <td class="px-4 py-2" data-field="status">
            {% if item.status == 'PL' %}
            <span class="inline-flex px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs font-medium">Queued</span>
            {% elif item.status == 'WD' %}
            <span class="inline-flex px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium">Checked In</span>
            {% elif item.status == 'MD' %}
            <span class="inline-flex px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-medium">With Doctor</span>
            {% elif item.status == 'WR' %}
            <span class="inline-flex px-2 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-medium">Waiting Room</span>
            {% elif item.status == 'MR' %}
            <span class="inline-flex px-2 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-medium">In Room</span>
            {% else %}
            <span class="inline-flex px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs font-medium">{{ item.get_status_display }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-2" data-field="room">{{ item.assigned_room.name|default:"-" }}</td>
          <td class="px-4 py-2 text-right" data-field="action">
            {% if item.status == 'PL' and not doctor_busy %}
            <form method="post" action="{% url 'appointments:check_in' item.id %}" class="inline">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <button type="submit" class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700">
                Check In
              </button>
            </form>
            {% elif item.status == 'PL' and doctor_busy %}
            <button type="button" disabled class="bg-gray-200 text-gray-500 px-3 py-1.5 rounded cursor-not-allowed">
              Check In
            </button>
            {% else %}
            <span class="text-gray-400">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr id="frontdesk-empty" class="{% if appointments %}hidden{% endif %}">
          <td colspan="5" class="px-4 py-6 text-center text-gray-500">No appointments in active queue.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const body = document.getElementById("frontdesk-body");
    const emptyRow = document.getElementById("frontdesk-empty");
    const activeStatuses = new Set(["PL", "WD", "MD", "WR", "MR"]);
    const currentPath = window.location.pathname + window.location.search;
    let doctorBusy = {{ doctor_busy|yesno:"true,false" }};

    if (!body || !emptyRow) {
      return;
    }

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function toggleEmptyState() {
      const hasRows = body.querySelector("tr[data-appointment-id]") !== null;
      emptyRow.classList.toggle("hidden", hasRows);
    }

    function actionHtml(appointmentId, statusCode) {
      if (statusCode !== "PL") {
        return '<span class="text-gray-400">-</span>';
      }

      if (doctorBusy) {
        return '<button type="button" disabled class="bg-gray-200 text-gray-500 px-3 py-1.5 rounded cursor-not-allowed">Check In</button>';
      }

      const csrfToken = escapeHtml(getCsrfToken());
      return [
        `<form method="post" action="/appointments/${appointmentId}/check-in/" class="inline">`,
        `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
        `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
        '<button type="submit" class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700">Check In</button>',
        "</form>",
      ].join("");
    }

    function isEmergency(payload) {
      return Boolean(payload.reason && payload.reason.startsWith("[EMERGENCY]"));
    }

    function patientHtml(payload) {
      const badge = isEmergency(payload)
        ? ' <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-xs font-semibold">Emergency</span>'
        : "";
      return `${escapeHtml(payload.patient_name || "Patient")}${badge}`;
    }

    function statusHtml(statusCode, statusLabel) {
      if (statusCode === "PL") {
        return '<span class="inline-flex px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs font-medium">Queued</span>';
      }
      if (statusCode === "WD") {
        return '<span class="inline-flex px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium">Checked In</span>';
      }
      if (statusCode === "MD") {
        return '<span class="inline-flex px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-medium">With Doctor</span>';
      }
      if (statusCode === "WR") {
        return '<span class="inline-flex px-2 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-medium">Waiting Room</span>';
      }
      if (statusCode === "MR") {
        return '<span class="inline-flex px-2 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-medium">In Room</span>';
      }
      return `<span class="inline-flex px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs font-medium">${escapeHtml(statusLabel || statusCode || "Unknown")}</span>`;
    }

    function ensureRow(payload) {
      let row = body.querySelector(`tr[data-appointment-id="${payload.appointment_id}"]`);
      if (!row) {
        row = document.createElement("tr");
        row.className = "border-t hover:bg-gray-50";
        row.dataset.appointmentId = payload.appointment_id;
        row.dataset.statusCode = payload.status || "PL";
        row.innerHTML = [
          '<td class="px-4 py-2" data-field="time"></td>',
          '<td class="px-4 py-2 font-medium" data-field="patient"></td>',
          '<td class="px-4 py-2" data-field="status"></td>',
          '<td class="px-4 py-2" data-field="room"></td>',
          '<td class="px-4 py-2 text-right" data-field="action"></td>',
        ].join("");
        body.insertBefore(row, emptyRow);
      }
      return row;
    }

    function recalculateDoctorBusy() {
      doctorBusy = body.querySelector('tr[data-status-code="MD"]') !== null;
    }

    function refreshPlannedActions() {
      const rows = body.querySelectorAll("tr[data-appointment-id]");
      rows.forEach(function (row) {
        const statusCode = row.dataset.statusCode || "";
        const appointmentId = row.dataset.appointmentId;
        const actionCell = row.querySelector('[data-field="action"]');
        if (!actionCell || !appointmentId) {
          return;
        }
        actionCell.innerHTML = actionHtml(appointmentId, statusCode);
      });
    }

    window.clinicFlowHandleEvent = function (payload) {
      if (!payload || !payload.appointment_id) {
        return;
      }

      const existingRow = body.querySelector(`tr[data-appointment-id="${payload.appointment_id}"]`);
      if (!activeStatuses.has(payload.status)) {
        if (existingRow) {
          existingRow.remove();
        }
        recalculateDoctorBusy();
        refreshPlannedActions();
        toggleEmptyState();
        return;
      }

      const row = ensureRow(payload);
      row.querySelector('[data-field="time"]').textContent = payload.scheduled_time || "";
      row.className = isEmergency(payload)
        ? "border-t hover:bg-gray-50 bg-red-50"
        : "border-t hover:bg-gray-50";
      row.dataset.statusCode = payload.status || "";
      row.querySelector('[data-field="patient"]').innerHTML = patientHtml(payload);
      row.querySelector('[data-field="status"]').innerHTML = statusHtml(payload.status, payload.status_label);
      row.querySelector('[data-field="room"]').textContent = payload.room_name || "-";

      recalculateDoctorBusy();
      refreshPlannedActions();

      toggleEmptyState();
    };

    recalculateDoctorBusy();
    refreshPlannedActions();
  })();
</script>

{% include "appointments/_live_socket.html" %}
{% endblock %}
