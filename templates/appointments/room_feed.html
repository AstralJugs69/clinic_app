{% extends "base.html" %}
{% block content %}

<div class="max-w-6xl mx-auto px-4 py-6 space-y-5">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">{{ room.name }} Live Feed</h1>
      <p class="text-sm text-gray-500">Receive transfers, continue care, and route patients.</p>
    </div>
    <div class="flex gap-2 flex-wrap">
      <a href="{% url 'appointments:frontdesk_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Front Desk</a>
      <a href="{% url 'appointments:doctor_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Doctor Feed</a>
      {% for room_item in rooms %}
      <a href="{% url 'appointments:room_feed' room_item.code %}"
         class="px-3 py-2 border rounded hover:bg-gray-50 text-sm {% if room_item.id == room.id %}font-semibold bg-gray-50{% endif %}">{{ room_item.name }}</a>
      {% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-5">
    <div class="bg-white shadow rounded p-4">
      <h2 class="text-lg font-semibold mb-3">Waiting for {{ room.name }}</h2>
      <div class="space-y-3">
        {% for item in waiting_room %}
        <div class="border rounded p-3 flex items-center justify-between gap-3">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} · {{ item.reason|default:"No reason" }}</p>
          </div>
          <form method="post" action="{% url 'appointments:room_accept' item.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <button type="submit" class="bg-teal-600 text-white px-3 py-1.5 rounded hover:bg-teal-700">Accept</button>
          </form>
        </div>
        {% empty %}
        <p class="text-sm text-gray-500">No patients waiting for this room.</p>
        {% endfor %}
      </div>
    </div>

    <div class="bg-white shadow rounded p-4">
      <h2 class="text-lg font-semibold mb-3">Currently in {{ room.name }}</h2>
      <div class="space-y-3">
        {% for item in in_room %}
        <div class="border rounded p-3 space-y-2">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} · {{ item.reason|default:"No reason" }}</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <form method="post" action="{% url 'appointments:complete' item.id %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <button type="submit" class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700">Complete</button>
            </form>

            {% if other_rooms %}
            <form method="post" action="{% url 'appointments:room_transfer' item.id %}" class="flex gap-2">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <select name="room_id" class="border rounded px-2 py-1.5 text-sm" required>
                <option value="">Transfer room</option>
                {% for room_item in other_rooms %}
                <option value="{{ room_item.id }}">{{ room_item.name }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700">Transfer</button>
            </form>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <p class="text-sm text-gray-500">No patients currently in this room.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% include "appointments/_live_socket.html" %}
{% endblock %}
