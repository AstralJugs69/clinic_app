{% extends "base.html" %}
{% block content %}

<div class="max-w-6xl mx-auto px-4 py-6 space-y-5">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">{{ room.name }} Live Feed</h1>
      <p class="text-sm text-gray-500">Receive transfers, continue care, and route patients.</p>
    </div>
    <div class="flex gap-2 flex-wrap">
      <a href="{% url 'appointments:frontdesk_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Front Desk</a>
      <a href="{% url 'appointments:doctor_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Doctor Feed</a>
      {% for room_item in rooms %}
      <a href="{% url 'appointments:room_feed' room_item.code %}"
         class="px-3 py-2 border rounded hover:bg-gray-50 text-sm {% if room_item.id == room.id %}font-semibold bg-gray-50{% endif %}">{{ room_item.name }}</a>
      {% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-5">
    <div class="bg-white shadow rounded p-4">
      <h2 class="text-lg font-semibold mb-3">Waiting for {{ room.name }}</h2>
      <div class="space-y-3" id="room-waiting-list">
        {% for item in waiting_room %}
        <div class="border rounded p-3 flex items-center justify-between gap-3" data-appointment-id="{{ item.id }}">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} 路 {{ item.reason|default:"No reason" }}</p>
          </div>
          <form method="post" action="{% url 'appointments:room_accept' item.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <button type="submit" class="bg-teal-600 text-white px-3 py-1.5 rounded hover:bg-teal-700">Accept</button>
          </form>
        </div>
        {% endfor %}
      </div>
      <p id="room-waiting-empty" class="text-sm text-gray-500 {% if waiting_room %}hidden{% endif %}">No patients waiting for this room.</p>
    </div>

    <div class="bg-white shadow rounded p-4">
      <h2 class="text-lg font-semibold mb-3">Currently in {{ room.name }}</h2>
      <div class="space-y-3" id="room-active-list">
        {% for item in in_room %}
        <div class="border rounded p-3 space-y-2" data-appointment-id="{{ item.id }}">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} 路 {{ item.reason|default:"No reason" }}</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <form method="post" action="{% url 'appointments:complete' item.id %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <button type="submit" class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700">Complete</button>
            </form>

            {% if other_rooms %}
            <form method="post" action="{% url 'appointments:room_transfer' item.id %}" class="flex gap-2">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}" />
              <select name="room_id" class="border rounded px-2 py-1.5 text-sm" required>
                <option value="">Transfer room</option>
                {% for room_item in other_rooms %}
                <option value="{{ room_item.id }}">{{ room_item.name }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700">Transfer</button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      <p id="room-active-empty" class="text-sm text-gray-500 {% if in_room %}hidden{% endif %}">No patients currently in this room.</p>
    </div>
  </div>
</div>

<script>
  (function () {
    const waitingList = document.getElementById("room-waiting-list");
    const activeList = document.getElementById("room-active-list");
    const waitingEmpty = document.getElementById("room-waiting-empty");
    const activeEmpty = document.getElementById("room-active-empty");
    const currentRoomCode = "{{ room.code|escapejs }}";
    const currentPath = window.location.pathname + window.location.search;
    const transferOptionsHtml = '{% for room_item in other_rooms %}<option value="{{ room_item.id }}">{{ room_item.name|escapejs }}</option>{% endfor %}';

    if (!waitingList || !activeList || !waitingEmpty || !activeEmpty) {
      return;
    }

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function toggleEmptyState() {
      waitingEmpty.classList.toggle(
        "hidden",
        waitingList.querySelector("[data-appointment-id]") !== null
      );
      activeEmpty.classList.toggle(
        "hidden",
        activeList.querySelector("[data-appointment-id]") !== null
      );
    }

    function removeExistingCard(appointmentId) {
      const waitingCard = waitingList.querySelector(`[data-appointment-id="${appointmentId}"]`);
      const activeCard = activeList.querySelector(`[data-appointment-id="${appointmentId}"]`);

      if (waitingCard) {
        waitingCard.remove();
      }
      if (activeCard) {
        activeCard.remove();
      }
    }

    function waitingCardHtml(payload) {
      const csrfToken = escapeHtml(getCsrfToken());
      const reason = payload.reason ? escapeHtml(payload.reason) : "No reason";

      return [
        `<div class="border rounded p-3 flex items-center justify-between gap-3" data-appointment-id="${payload.appointment_id}">`,
        "<div>",
        `<p class="font-medium">${escapeHtml(payload.patient_name || "Patient")}</p>`,
        `<p class="text-sm text-gray-500">${escapeHtml(payload.scheduled_time || "--:--")} 路 ${reason}</p>`,
        "</div>",
        `<form method="post" action="/appointments/${payload.appointment_id}/room-accept/">`,
        `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
        `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
        '<button type="submit" class="bg-teal-600 text-white px-3 py-1.5 rounded hover:bg-teal-700">Accept</button>',
        "</form>",
        "</div>",
      ].join("");
    }

    function activeCardHtml(payload) {
      const csrfToken = escapeHtml(getCsrfToken());
      const reason = payload.reason ? escapeHtml(payload.reason) : "No reason";
      const transferForm = transferOptionsHtml
        ? [
            `<form method="post" action="/appointments/${payload.appointment_id}/room-transfer/" class="flex gap-2">`,
            `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
            `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
            '<select name="room_id" class="border rounded px-2 py-1.5 text-sm" required>',
            '<option value="">Transfer room</option>',
            transferOptionsHtml,
            "</select>",
            '<button type="submit" class="bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700">Transfer</button>',
            "</form>",
          ].join("")
        : "";

      return [
        `<div class="border rounded p-3 space-y-2" data-appointment-id="${payload.appointment_id}">`,
        "<div>",
        `<p class="font-medium">${escapeHtml(payload.patient_name || "Patient")}</p>`,
        `<p class="text-sm text-gray-500">${escapeHtml(payload.scheduled_time || "--:--")} 路 ${reason}</p>`,
        "</div>",
        '<div class="flex gap-2 flex-wrap">',
        `<form method="post" action="/appointments/${payload.appointment_id}/complete/">`,
        `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
        `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
        '<button type="submit" class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700">Complete</button>',
        "</form>",
        transferForm,
        "</div>",
        "</div>",
      ].join("");
    }

    window.clinicFlowHandleEvent = function (payload) {
      if (!payload || !payload.appointment_id) {
        return;
      }

      removeExistingCard(payload.appointment_id);

      if (payload.room !== currentRoomCode) {
        toggleEmptyState();
        return;
      }

      if (payload.status === "WR") {
        waitingList.insertAdjacentHTML("beforeend", waitingCardHtml(payload));
      } else if (payload.status === "MR") {
        activeList.insertAdjacentHTML("beforeend", activeCardHtml(payload));
      }

      toggleEmptyState();
    };

    toggleEmptyState();
  })();
</script>

{% include "appointments/_live_socket.html" %}
{% endblock %}
