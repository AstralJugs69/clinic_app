{% extends "base.html" %}
{% block content %}

<div class="max-w-6xl mx-auto px-4 py-6 space-y-5">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold">Doctor Live Feed</h1>
      <p class="text-sm text-gray-500">Focus on one active treatment, then route to next room.</p>
      {% if doctor_busy %}
      <p class="text-xs text-amber-700 mt-1">Doctor is already with a patient. Accept is paused until current session is transferred.</p>
      {% endif %}
    </div>
    <div class="flex gap-2 flex-wrap">
      <a href="{% url 'appointments:frontdesk_feed' %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">Front Desk</a>
      {% for room_item in rooms %}
      <a href="{% url 'appointments:room_feed' room_item.code %}" class="px-3 py-2 border rounded hover:bg-gray-50 text-sm">{{ room_item.name }}</a>
      {% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-3">
    <div class="bg-white shadow rounded p-3">
      <p class="text-xs text-gray-500">Current Treatment</p>
      <p class="text-xl font-semibold text-indigo-700">{{ with_doctor|length }}</p>
    </div>
    <div class="bg-white shadow rounded p-3">
      <p class="text-xs text-gray-500">Waiting for Doctor</p>
      <p class="text-xl font-semibold text-blue-700">{{ waiting_doctor|length }}</p>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-5">
    <div class="bg-white shadow rounded p-4 md:order-2">
      <h2 class="text-lg font-semibold mb-3">Waiting Queue</h2>
      <div class="space-y-3" id="doctor-waiting-list">
        {% for item in waiting_doctor %}
        <div class="border rounded p-3 flex items-center justify-between gap-3" data-appointment-id="{{ item.id }}">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} 路 {{ item.reason|default:"No reason" }}</p>
          </div>
          <form method="post" action="{% url 'appointments:doctor_accept' item.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <button type="submit" {% if doctor_busy %}disabled{% endif %} class="{% if doctor_busy %}bg-gray-200 text-gray-500 cursor-not-allowed{% else %}bg-blue-600 text-white hover:bg-blue-700{% endif %} px-3 py-1.5 rounded">Accept</button>
          </form>
        </div>
        {% endfor %}
      </div>
      <p id="doctor-waiting-empty" class="text-sm text-gray-500 {% if waiting_doctor %}hidden{% endif %}">No patients waiting in queue.</p>
    </div>

    <div class="bg-white shadow rounded p-4 md:order-1">
      <h2 class="text-lg font-semibold mb-3">Current Treatment</h2>
      <div class="space-y-3" id="doctor-active-list">
        {% for item in with_doctor %}
        <div class="border rounded p-3 space-y-2" data-appointment-id="{{ item.id }}">
          <div>
            <p class="font-medium">{{ item.patient.full_name }}</p>
            <p class="text-sm text-gray-500">{{ item.scheduled_at|date:"H:i" }} 路 {{ item.reason|default:"No reason" }}</p>
          </div>
          <form method="post" action="{% url 'appointments:transfer_to_room' item.id %}" class="flex items-center gap-2">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <select name="room_id" class="border rounded px-2 py-1.5 text-sm flex-1" required>
              <option value="">Select room</option>
              {% for room_item in rooms %}
              <option value="{{ room_item.id }}">{{ room_item.name }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700">Send</button>
          </form>
        </div>
        {% endfor %}
      </div>
      <p id="doctor-active-empty" class="text-sm text-gray-500 {% if with_doctor %}hidden{% endif %}">Doctor is available. Accept a patient from queue.</p>
    </div>
  </div>
</div>

<script>
  (function () {
    const waitingList = document.getElementById("doctor-waiting-list");
    const activeList = document.getElementById("doctor-active-list");
    const waitingEmpty = document.getElementById("doctor-waiting-empty");
    const activeEmpty = document.getElementById("doctor-active-empty");
    const currentPath = window.location.pathname + window.location.search;
    const roomOptionsHtml = '{% for room_item in rooms %}<option value="{{ room_item.id }}">{{ room_item.name|escapejs }}</option>{% endfor %}';
    let doctorBusy = {{ doctor_busy|yesno:"true,false" }};

    if (!waitingList || !activeList || !waitingEmpty || !activeEmpty) {
      return;
    }

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function toggleEmptyState() {
      waitingEmpty.classList.toggle(
        "hidden",
        waitingList.querySelector("[data-appointment-id]") !== null
      );
      activeEmpty.classList.toggle(
        "hidden",
        activeList.querySelector("[data-appointment-id]") !== null
      );
    }

    function removeExistingCard(appointmentId) {
      const waitingCard = waitingList.querySelector(`[data-appointment-id="${appointmentId}"]`);
      const activeCard = activeList.querySelector(`[data-appointment-id="${appointmentId}"]`);

      if (waitingCard) {
        waitingCard.remove();
      }
      if (activeCard) {
        activeCard.remove();
      }
    }

    function acceptButtonHtml() {
      if (doctorBusy) {
        return '<button type="submit" disabled class="bg-gray-200 text-gray-500 cursor-not-allowed px-3 py-1.5 rounded">Accept</button>';
      }
      return '<button type="submit" class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">Accept</button>';
    }

    function refreshAcceptButtons() {
      const forms = waitingList.querySelectorAll('form[action$="/doctor-accept/"]');
      forms.forEach(function (form) {
        const button = form.querySelector("button");
        if (!button) {
          return;
        }
        button.disabled = doctorBusy;
        if (doctorBusy) {
          button.className = "bg-gray-200 text-gray-500 cursor-not-allowed px-3 py-1.5 rounded";
        } else {
          button.className = "bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700";
        }
      });
    }

    function recalculateDoctorBusy() {
      doctorBusy = activeList.querySelector("[data-appointment-id]") !== null;
    }

    function waitingCardHtml(payload) {
      const csrfToken = escapeHtml(getCsrfToken());
      const reason = payload.reason ? escapeHtml(payload.reason) : "No reason";

      return [
        `<div class="border rounded p-3 flex items-center justify-between gap-3" data-appointment-id="${payload.appointment_id}">`,
        "<div>",
        `<p class="font-medium">${escapeHtml(payload.patient_name || "Patient")}</p>`,
        `<p class="text-sm text-gray-500">${escapeHtml(payload.scheduled_time || "--:--")} 路 ${reason}</p>`,
        "</div>",
        `<form method="post" action="/appointments/${payload.appointment_id}/doctor-accept/">`,
        `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
        `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
        acceptButtonHtml(),
        "</form>",
        "</div>",
      ].join("");
    }

    function activeCardHtml(payload) {
      const csrfToken = escapeHtml(getCsrfToken());
      const reason = payload.reason ? escapeHtml(payload.reason) : "No reason";

      return [
        `<div class="border rounded p-3 space-y-2" data-appointment-id="${payload.appointment_id}">`,
        "<div>",
        `<p class="font-medium">${escapeHtml(payload.patient_name || "Patient")}</p>`,
        `<p class="text-sm text-gray-500">${escapeHtml(payload.scheduled_time || "--:--")} 路 ${reason}</p>`,
        "</div>",
        `<form method="post" action="/appointments/${payload.appointment_id}/send-room/" class="flex items-center gap-2">`,
        `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`,
        `<input type="hidden" name="next" value="${escapeHtml(currentPath)}">`,
        '<select name="room_id" class="border rounded px-2 py-1.5 text-sm flex-1" required>',
        '<option value="">Select room</option>',
        roomOptionsHtml,
        "</select>",
        '<button type="submit" class="bg-amber-600 text-white px-3 py-1.5 rounded hover:bg-amber-700">Send</button>',
        "</form>",
        "</div>",
      ].join("");
    }

    window.clinicFlowHandleEvent = function (payload) {
      if (!payload || !payload.appointment_id) {
        return;
      }

      removeExistingCard(payload.appointment_id);

      if (payload.status === "WD") {
        waitingList.insertAdjacentHTML("beforeend", waitingCardHtml(payload));
      } else if (payload.status === "MD") {
        activeList.insertAdjacentHTML("beforeend", activeCardHtml(payload));
      }

      recalculateDoctorBusy();
      refreshAcceptButtons();
      toggleEmptyState();
    };

    recalculateDoctorBusy();
    refreshAcceptButtons();
    toggleEmptyState();
  })();
</script>

{% include "appointments/_live_socket.html" %}
{% endblock %}
